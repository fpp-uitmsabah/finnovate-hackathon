<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hype vs. Horizon: The Game</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Google Font (Inter) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <!-- 3. Tone.js for Sound Effects -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.min.js"></script>
    
    <!-- 4. Custom Styles -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0fdfa; /* teal-50 */
        }
        /* Active nav item */
        .nav-active {
            color: #0d9488; /* teal-600 */
        }
        /* Hide scrollbars */
        ::-webkit-scrollbar {
            width: 0;
            height: 0;
            background: transparent;
        }
        
        /* Chart line styles */
        .hype-line {
            fill: none;
            stroke: #ef4444; /* red-500 */
            stroke-width: 3;
            stroke-linecap: round;
            stroke-linejoin: round;
            transition: d 0.1s ease-out;
        }
        .horizon-line {
            fill: none;
            stroke: #0d9488; /* teal-600 */
            stroke-width: 3;
            stroke-linecap: round;
            stroke-linejoin: round;
            transition: d 0.1s ease-out;
        }
        
        /* Main action button pulse */
        @keyframes pulse {
            0%, 100% {
                transform: scale(1) translateY(-1.5rem);
                box-shadow: 0 4px 15px rgba(13, 148, 136, 0.4);
            }
            50% {
                transform: scale(1.05) translateY(-1.5rem);
                box-shadow: 0 8px 25px rgba(13, 148, 136, 0.6);
            }
        }
        .animate-pulse-strong {
            animation: pulse 2s infinite ease-in-out;
        }
        
        /* Card flash animations */
        @keyframes flash-green {
            0% { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
            50% { box-shadow: 0 0 0 4px rgba(74, 222, 128, 0.7); }
            100% { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        }
        .animate-flash-green {
            animation: flash-green 0.7s ease-out;
        }
        @keyframes flash-red {
            0% { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
            50% { box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.7); }
            100% { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        }
        .animate-flash-red {
            animation: flash-red 0.7s ease-out;
        }

        /* Badge toast animation */
        @keyframes slide-in-top {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        #badge-toast {
            animation: slide-in-top 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }
        
        /* Badge styles */
        .badge-locked {
            filter: grayscale(1) opacity(0.4);
        }
        
        /* Ensure numbers don't jump around while ticking */
        .tabular-nums {
            font-variant-numeric: tabular-nums;
        }
    </style>
</head>
<body class="bg-teal-50">

    <!-- 
      Badge Unlocked Toast Notification
    -->
    <div id="badge-toast" class="fixed top-4 left-1/2 -translate-x-1/2 z-50 w-[90%] max-w-sm bg-white p-4 rounded-xl shadow-2xl border-2 border-yellow-300 hidden">
        <div class="flex items-center space-x-3">
            <div id="badge-toast-icon" class="text-4xl">üèÜ</div>
            <div>
                <h3 class="font-bold text-gray-800">Badge Unlocked!</h3>
                <p id="badge-toast-name" class="text-sm text-gray-600">The Turtle</p>
            </div>
        </div>
    </div>

    <!-- 
      Main App Content
    -->
    <div id="app-container" class="pb-24 max-w-lg mx-auto">
        
        <!-- === Page: The Race (Simulation) === -->
        <div id="page-race" class="p-4 space-y-6">
            <!-- Header -->
            <div class="flex justify-between items-center pt-4">
                <h1 class="text-3xl font-bold text-teal-900">The Race</h1>
                <button id="restart-btn" class="text-sm bg-white text-teal-600 font-semibold py-2 px-4 rounded-lg shadow-md border border-gray-200 hover:bg-gray-50">
                    Restart
                </button>
            </div>
            
            <!-- Score & Status Card -->
            <div class="bg-gradient-to-br from-white to-teal-100 p-6 rounded-2xl shadow-lg">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <div class="text-sm font-semibold text-gray-500 uppercase">Prudence Score</div>
                        <div id="prudence-score" class="text-3xl font-bold text-teal-700 tabular-nums">0</div>
                    </div>
                    <div class="text-right">
                        <div class="text-sm font-semibold text-gray-500 uppercase">Time Elapsed</div>
                        <div id="month-display" class="text-3xl font-bold text-teal-700 tabular-nums">0 / 120</div>
                    </div>
                </div>
                <div id="winner-display" class="text-lg font-bold p-3 rounded-lg text-center mt-4 hidden">
                    <!-- Winner text injected here -->
                </div>
            </div>
            
            <!-- Portfolio Totals -->
            <div class="grid grid-cols-2 gap-4">
                <!-- Hype Portfolio -->
                <div id="hype-card" class="bg-white p-5 rounded-2xl shadow-md border-2 border-red-200">
                    <div class="flex items-center space-x-3">
                        <span class="text-2xl">üöÄ</span>
                        <h2 class="text-lg font-bold text-red-700">Hype</h2>
                    </div>
                    <p id="hype-balance" class="text-3xl font-extrabold text-red-600 mt-3 tabular-nums">RM 1,000</p>
                </div>
                <!-- Horizon Portfolio -->
                <div id="horizon-card" class="bg-white p-5 rounded-2xl shadow-md border-2 border-teal-200">
                    <div class="flex items-center space-x-3">
                        <span class="text-2xl">üå±</span>
                        <h2 class="text-lg font-bold text-teal-700">Horizon</h2>
                    </div>
                    <p id="horizon-balance" class="text-3xl font-extrabold text-teal-600 mt-3 tabular-nums">RM 1,000</p>
                </div>
            </div>
            
            <!-- Live Chart Card -->
            <div class="bg-white p-6 rounded-2xl shadow-md">
                <h2 class="text-lg font-semibold text-gray-700 mb-4">10-Year Race</h2>
                <div class="w-full h-48 bg-gray-50 rounded-lg overflow-hidden">
                    <svg id="chart-svg" viewBox="0 0 300 150" class="w-full h-full" preserveAspectRatio="none">
                        <polyline id="horizon-line-chart" class="horizon-line" points="0,149"></polyline>
                        <polyline id="hype-line-chart" class="hype-line" points="0,149"></polyline>
                        <circle id="hype-dot" r="4" fill="#ef4444" class="opacity-70"></circle>
                        <circle id="horizon-dot" r="4" fill="#0d9488" class="opacity-70"></circle>
                    </svg>
                </div>
            </div>

            <!-- News Feed Card -->
            <div class="bg-white p-6 rounded-2xl shadow-md">
                <h2 class="text-lg font-semibold text-gray-700 mb-4">Live Market News</h2>
                <ul id="news-feed" class="space-y-3 h-32 overflow-y-scroll">
                    <li class="text-center text-gray-400">Press "Next Month" to start!</li>
                </ul>
            </div>
        </div>

        <!-- === Page: The Lesson === -->
        <div id="page-lesson" class="p-4 space-y-6 hidden">
            <h1 class="text-3xl font-bold text-teal-900 pt-4">Scam Spotter's Guide</h1>
            
            <!-- Red Flags Card -->
            <div class="bg-white p-6 rounded-2xl shadow-md">
                <h2 class="text-xl font-bold text-red-700 mb-4">üö® Red Flags of "Get Rich Quick"</h2>
                <p class="text-gray-600 mb-6">If it sounds too good to be true, it almost always is. Watch out for these traps:</p>
                <ul id="red-flags-list" class="space-y-4">
                    <!-- Red flags injected by JS -->
                </ul>
            </div>

            <!-- Green Flags Card -->
            <div class="bg-white p-6 rounded-2xl shadow-md">
                <h2 class="text-xl font-bold text-teal-700 mb-4">üå± The "Get Rich Slow" Way</h2>
                <ul id="green-flags-list" class="space-y-4">
                    <!-- Green flags injected by JS -->
                </ul>
            </div>
        </div>
        
        <!-- === Page: Badges === -->
        <div id="page-badges" class="p-4 space-y-6 hidden">
            <h1 class="text-3xl font-bold text-teal-900 pt-4">Your Badges</h1>
            <p class="text-gray-600">Unlock achievements as you play the simulation.</p>
            
            <div id="badge-grid" class="grid grid-cols-2 gap-4">
                <!-- Badges injected by JS -->
            </div>
        </div>

        <!-- === Page: About === -->
        <div id="page-about" class="p-4 space-y-6 hidden">
            <h1 class="text-3xl font-bold text-teal-900 pt-4">About This Sim</h1>
            <div class_ ="bg-white p-6 rounded-2xl shadow-md space-y-4 text-gray-700">
                <p>This simulation was built to demonstrate **Challenge #2: The "Get Rich Quick" Mindset**.</p>
                <p>Each month, you invest **RM 500** into two portfolios:</p>
                <p>The <span class="font-bold text-teal-600">Horizon Portfolio</span> represents a boring, diversified, low-cost index fund. It grows at a steady, average rate and never crashes. This is the "Get Rich Slow" method.</p>
                <p>The <span class="font-bold text-red-600">Hype Portfolio</span> represents chasing meme stocks, hype crypto, or other high-risk assets. It's a gamble, influenced by random "Market Events" that can make you rich or wipe you out.</p>
                <p>Your **Prudence Score** is the difference between your Horizon and Hype portfolios. A high score proves that slow and steady wins the race.</p>
            </div>
        </div>

    </div> <!-- End #app-container -->

    <!-- 
      Bottom Navigation Bar
    -->
    <nav class="fixed bottom-0 left-0 right-0 max-w-lg mx-auto h-20 bg-white border-t border-gray-200 shadow-[0_-4px_10px_-1px_rgba(0,0,0,0.05)] grid grid-cols-5 items-center px-4 rounded-t-2xl">
        <!-- Nav: Race -->
        <button data-page="race" class="nav-btn flex flex-col items-center justify-center text-gray-500 hover:text-teal-600 nav-active">
            <svg class="w-7 h-7" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12.0006 1.62109L22.607 9.87321V22.3732H1.39429V9.87321L12.0006 1.62109ZM12.0006 4.31481L3.39429 10.9995V20.3732H9.0006V14.3732H15.0006V20.3732H20.607V10.9995L12.0006 4.31481Z"></path></svg>
            <span class="text-xs font-medium mt-1">Race</span>
        </button>
        
        <!-- Nav: Lesson -->
        <button data-page="lesson" class="nav-btn flex flex-col items-center justify-center text-gray-500 hover:text-teal-600">
            <svg class="w-7 h-7" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20 2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM4 18V6h16v12H4zM6 8h12v2H6V8zm0 4h12v2H6v-2z"></path></svg>
            <span class="text-xs font-medium mt-1">Lesson</span>
        </button>
        
        <!-- Action: Next Month -->
        <button id="next-month-btn" class="flex items-center justify-center -translate-y-6 animate-pulse-strong">
            <div class="bg-teal-500 text-white rounded-full p-5 shadow-lg shadow-teal-500/50 hover:bg-teal-600 transition-all">
                <svg class="w-8 h-8" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M16.1716 10.9999L10.8076 5.63589L12.2218 4.22168L20 11.9999L12.2218 19.778L10.8076 18.3638L16.1716 12.9999H4V10.9999H16.1716Z"></path></svg>
            </div>
        </button>
        
        <!-- Nav: Badges -->
        <button data-page="badges" class="nav-btn flex flex-col items-center justify-center text-gray-500 hover:text-teal-600">
            <svg class="w-7 h-7" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15l-3.5-3.5 1.41-1.41L11 14.17l5.59-5.59L18 10l-7 7z"></path></svg>
            <span class="text-xs font-medium mt-1">Badges</span>
        </button>

        <!-- Nav: About / Mute -->
        <button id="mute-btn" class="nav-btn flex flex-col items-center justify-center text-gray-500 hover:text-teal-600">
            <svg id="mute-icon" class="w-7 h-7" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"></path></svg>
            <svg id="unmute-icon" class="w-7 h-7 hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"></path></svg>
            <span class="text-xs font-medium mt-1">Mute</span>
        </button>
    </nav>


    <!-- 
      JavaScript Logic
    -->
    <script>
        // Use window.onload to wait for all resources (like Tone.js) to load
        window.addEventListener('load', () => {

            // --- Audio Setup ---
            const audioManager = {
                isMuted: false,
                synth: null, // Initialize as null
                polySynth: null, // Initialize as null
                
                // Init function to be called on first user interaction
                init: async function() {
                    if (this.synth) return; // Already initialized
                    try {
                        // Tone.start() must be called after a user gesture
                        await Tone.start(); 
                        this.synth = new Tone.Synth().toDestination();
                        this.polySynth = new Tone.PolySynth(Tone.Synth).toDestination();
                        console.log("Audio context started.");
                    } catch (e) {
                        console.error("Failed to initialize audio:", e);
                        this.isMuted = true; // Fail-safe: mute if audio context fails
                        document.getElementById('mute-icon').classList.remove('hidden');
                        document.getElementById('unmute-icon').classList.add('hidden');
                    }
                },
                
                play: async function(sound) {
                    // Initialize on first play attempt
                    if (!this.synth) {
                        await this.init();
                    }
                    
                    if (this.isMuted || !this.synth) return; // Check again in case init failed
                    
                    try {
                        const now = Tone.now();
                        if (sound === 'click') {
                            this.synth.triggerAttackRelease("C4", "16n", now);
                        } else if (sound === 'BOOM') {
                            this.polySynth.triggerAttackRelease(["C5", "E5", "G5"], "16n", now);
                        } else if (sound === 'BUST') {
                            this.polySynth.triggerAttackRelease(["G3", "D3", "A2"], "8n", now);
                        } else if (sound === 'STAG') {
                            this.synth.triggerAttackRelease("A3", "16n", now);
                        } else if (sound === 'badge') {
                            this.polySynth.triggerAttackRelease(["C5", "E5", "G5", "C6"], "8n", now);
                        }
                    } catch (e) {
                        console.warn("Audio play error:", e);
                    }
                },
                
                toggleMute: async function() {
                    // Initialize on first mute toggle if not already
                    if (!this.synth) {
                        await this.init();
                    }
                    
                    this.isMuted = !this.isMuted;
                    document.getElementById('mute-icon').classList.toggle('hidden', this.isMuted);
                    document.getElementById('unmute-icon').classList.toggle('hidden', !this.isMuted);
                }
            };
            
            // --- Game Data ---
            const monthlyInvestment = 500;
            const totalMonths = 120; // 10 years
            const HORIZON_GROWTH_RATE = 1.0072; // ~9% APR
            
            const marketEvents = [
                { type: 'BOOM', name: "MemeStock Surge!", desc: "Your Hype stock is on 1000 news sites! TO THE MOON!", hypeChange: 1.8, horizonChange: 1.01 }, // +80%
                { type: 'BOOM', name: "Crypto Bull Run!", desc: "A celebrity tweeted about HypeCoin! +50%", hypeChange: 1.5, horizonChange: 1.0 }, // +50%
                { type: 'BOOM', name: "Big Tech Earnings", desc: "Hype portfolio beats expectations! +20%", hypeChange: 1.2, horizonChange: 1.015 }, // +20%
                { type: 'BUST', name: "RUGPULL!", desc: "The HypeCoin founders vanished! It's worthless. -90%", hypeChange: 0.1, horizonChange: 1.0 }, // -90%
                { type: 'BUST', name: "Market Correction", desc: "The bubble burst! Hype assets fall. -40%", hypeChange: 0.6, horizonChange: 0.98 }, // -40%
                { type: 'BUST', name: "Bad News", desc: "HypeStock misses earnings badly! -25%", hypeChange: 0.75, horizonChange: 0.99 }, // -25%
                { type: 'STAG', name: "Stagnant Market", desc: "Nothing is happening... Hype is bored. -5%", hypeChange: 0.95, horizonChange: 1.0 }, // -5%
                { type: 'STAG', name: "Inflation Fears", desc: "Prices are up. Markets are flat. Hype -2%", hypeChange: 0.98, horizonChange: 0.995 }, // -2%
            ];
            
            let badges = [
                { id: 'THE_TURTLE', name: 'The Turtle', desc: 'Finish the 10-year simulation.', icon: 'üê¢', unlocked: false },
                { id: 'STEADY_HAND', name: 'Steady Hand', desc: 'Reach RM 25,000 in your Horizon portfolio.', icon: 'FCD', unlocked: false },
                { id: 'HORIZON_100K', name: 'Horizon Winner', desc: 'Reach RM 100,000 in your Horizon portfolio.', icon: 'üèÜ', unlocked: false },
                { id: 'RUGPULLED', name: 'Rugpulled!', desc: 'Experience a "RUGPULL!" event and lose 90%.', icon: 'üëª', unlocked: false },
                { id: 'FOMO_WINS', name: 'FOMO Wins', desc: 'Have your Hype portfolio be RM 10k ahead.', icon: 'üí∏', unlocked: false },
                { id: 'PRUDENCE_WINS', name: 'Prudence Wins', desc: 'Have your Horizon portfolio be RM 10k ahead.', icon: 'üßê', unlocked: false },
                { id: 'SURVIVOR', name: 'Survivor', desc: 'Finish the race without your Hype portfolio going to 0.', icon: 'Îß∑', unlocked: false },
                { id: 'BANKRUPT', name: 'Hype Bankrupt', desc: 'Your Hype portfolio went to RM 0.', icon: 'üíî', unlocked: false }
            ];
            
            const lessonData = {
                redFlags: [
                    { title: 'Guaranteed High Returns', desc: '"10% return *every month*!" Real investing has risk and no guarantees.' },
                    { title: 'Pressure to "Act NOW!"', desc: '"Buy now or you\'ll miss out!" Scammers use FOMO (Fear Of Missing Out) to rush you.' },
                    { title: 'Vague Details', desc: '"It\'s a secret crypto-AI-forex algorithm." If they can\'t explain it simply, it\'s often a scam.' },
                    { title: '"Everyone is doing it"', desc: 'Hype on social media doesn\'t mean it\'s a good investment. It often means you\'re late.' },
                    { title: 'Unlicensed "Gurus"', desc: 'Be wary of advice from influencers selling expensive courses or "private groups."' }
                ],
                greenFlags: [
                    { title: 'Diversification', desc: 'Don\'t put all your eggs in one basket. (The Horizon Portfolio is diversified).' },
                    { title: 'Compound Interest', desc: 'Your money earns money, which then earns *more* money. It\'s a slow, powerful snowball.' },
                    { title: 'Time *in* the Market', desc: 'The longer you stay invested, the more you grow. It\'s not about *timing* the market.' },
                    { title: 'Low Fees', desc: 'Look for low-cost index funds and ETFs so fees don\'t eat your returns.' }
                ]
            };

            // --- Game State ---
            let currentPage = 'race';
            let currentMonth = 0;
            let hypeBalance = 1000;
            let horizonBalance = 1000;
            let prudenceScore = 0;
            let hypeHistory = [1000];
            let horizonHistory = [1000];
            
            // --- DOM Element Refs ---
            const dom = {
                pages: {
                    race: document.getElementById('page-race'),
                    lesson: document.getElementById('page-lesson'),
                    badges: document.getElementById('page-badges'),
                    about: document.getElementById('page-about'),
                },
                nav: {
                    buttons: document.querySelectorAll('.nav-btn'),
                    nextMonthBtn: document.getElementById('next-month-btn'),
                    restartBtn: document.getElementById('restart-btn'),
                    muteBtn: document.getElementById('mute-btn'),
                },
                // Race Page
                monthDisplay: document.getElementById('month-display'),
                prudenceScore: document.getElementById('prudence-score'),
                hypeBalance: document.getElementById('hype-balance'),
                horizonBalance: document.getElementById('horizon-balance'),
                hypeCard: document.getElementById('hype-card'),
                horizonCard: document.getElementById('horizon-card'),
                chart: {
                    svg: document.getElementById('chart-svg'),
                    hypeLine: document.getElementById('hype-line-chart'),
                    horizonLine: document.getElementById('horizon-line-chart'),
                    hypeDot: document.getElementById('hype-dot'),
                    horizonDot: document.getElementById('horizon-dot'),
                },
                newsFeed: document.getElementById('news-feed'),
                winnerDisplay: document.getElementById('winner-display'),
                // Badges
                badgeGrid: document.getElementById('badge-grid'),
                badgeToast: {
                    element: document.getElementById('badge-toast'),
                    icon: document.getElementById('badge-toast-icon'),
                    name: document.getElementById('badge-toast-name'),
                }
            };

            // --- Helper Functions ---

            const formatCurrency = (amount) => {
                return new Intl.NumberFormat('en-MY', {
                    style: 'currency',
                    currency: 'MYR',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0,
                }).format(amount || 0);
            };
            
            // Number Ticker Animation
            function animateValue(element, start, end, duration) {
                if (start === end) {
                    element.textContent = formatCurrency(end);
                    return;
                }
                const range = end - start;
                let current = start;
                const increment = end > start ? 1 : -1;
                const stepTime = Math.abs(Math.floor(duration / range));
                
                const timer = setInterval(() => {
                    current += increment * Math.max(1, Math.abs(Math.floor(range / (duration / 50)))); // Faster steps
                    if ((increment > 0 && current >= end) || (increment < 0 && current <= end)) {
                        current = end;
                        clearInterval(timer);
                    }
                    element.textContent = formatCurrency(current);
                }, 10); // Run faster
            }

            const updatePage = (pageName) => {
                if (!pageName || !dom.pages[pageName]) return;
                currentPage = pageName;
                
                Object.values(dom.pages).forEach(page => page.classList.add('hidden'));
                dom.pages[currentPage].classList.remove('hidden');
                
                dom.nav.buttons.forEach(btn => {
                    const btnPage = btn.dataset.page;
                    if (btnPage) {
                        btn.classList.toggle('nav-active', btnPage === currentPage);
                    }
                });
                window.scrollTo(0, 0);
            };
            
            const logNews = (message, type = 'info') => {
                const li = document.createElement('li');
                li.className = 'news-item text-sm';
                let emoji = '‚ÑπÔ∏è';
                
                switch (type) {
                    case 'BOOM':
                        li.className += ' text-green-600 font-medium';
                        emoji = 'üöÄ';
                        break;
                    case 'BUST':
                        li.className += ' text-red-600 font-bold';
                        emoji = 'üö®';
                        break;
                    case 'STAG':
                        li.className += ' text-yellow-600';
                        emoji = 'üìâ';
                        break;
                }
                
                li.innerHTML = `<span class="mr-2">${emoji}</span>${message}`;
                
                if(dom.newsFeed.firstChild.textContent.includes('Press "Next Month"')) {
                    dom.newsFeed.innerHTML = '';
                }
                dom.newsFeed.prepend(li);
            };
            
            const flashCard = (cardElement, type) => {
                const animationClass = type === 'BOOM' ? 'animate-flash-green' : 'animate-flash-red';
                cardElement.classList.add(animationClass);
                setTimeout(() => cardElement.classList.remove(animationClass), 700);
            };
            
            // --- Badge & Lesson Functions ---
            
            const renderBadges = () => {
                dom.badgeGrid.innerHTML = badges.map(badge => `
                    <div class="bg-white p-4 rounded-xl shadow-md flex items-center space-x-4 ${!badge.unlocked ? 'badge-locked' : ''}">
                        <div class="text-5xl">${badge.icon}</div>
                        <div>
                            <h3 class="font-bold text-gray-800">${badge.name}</h3>
                            <p class="text-sm text-gray-600">${badge.desc}</p>
                        </div>
                    </div>
                `).join('');
            };
            
            const showBadgeToast = (badge) => {
                dom.badgeToast.icon.textContent = badge.icon;
                dom.badgeToast.name.textContent = badge.name;
                dom.badgeToast.element.classList.remove('hidden');
                setTimeout(() => dom.badgeToast.element.classList.add('hidden'), 3000);
            };
            
            const unlockBadge = (id) => {
                const badge = badges.find(b => b.id === id);
                if (badge && !badge.unlocked) {
                    badge.unlocked = true;
                    audioManager.play('badge');
                    showBadgeToast(badge);
                    renderBadges();
                }
            };
            
            const checkBadges = () => {
                if (currentMonth >= totalMonths) unlockBadge('THE_TURTLE');
                if (horizonBalance >= 25000) unlockBadge('STEADY_HAND');
                if (horizonBalance >= 100000) unlockBadge('HORIZON_100K');
                if (prudenceScore >= 10000) unlockBadge('PRUDENCE_WINS');
                if (prudenceScore <= -10000) unlockBadge('FOMO_WINS');
                if (hypeBalance <= 0) unlockBadge('BANKRUPT');
                if (currentMonth >= totalMonths && hypeBalance > 0) unlockBadge('SURVIVOR');
            };
            
            const populateLessons = () => {
                const redFlagsHtml = lessonData.redFlags.map((item, i) => `
                    <li class="flex space-x-3">
                        <div class="text-red-500 font-bold">${i + 1}.</div>
                        <div><strong>${item.title}:</strong> ${item.desc}</div>
                    </li>`).join('');
                
                const redFlagsList = document.getElementById('red-flags-list');
                if (redFlagsList) {
                    redFlagsList.innerHTML = redFlagsHtml;
                } else {
                    console.error("Could not find #red-flags-list element");
                }
                
                const greenFlagsHtml = lessonData.greenFlags.map(item => `
                    <li class="flex space-x-3">
                        <div class="text-teal-500 font-bold">‚úì</div>
                        <div><strong>${item.title}:</strong> ${item.desc}</div>
                    </li>`).join('');

                const greenFlagsList = document.getElementById('green-flags-list');
                if (greenFlagsList) {
                    greenFlagsList.innerHTML = greenFlagsHtml;
                } else {
                    console.error("Could not find #green-flags-list element");
                }
            };

            // --- Render Functions ---

            const renderPortfolios = () => {
                // Animate the values
                animateValue(dom.hypeBalance, parseInt(dom.hypeBalance.textContent.replace(/[^0-9-]/g, '')) || 0, hypeBalance, 300);
                animateValue(dom.horizonBalance, parseInt(dom.horizonBalance.textContent.replace(/[^0-9-]/g, '')) || 0, horizonBalance, 300);
                animateValue(dom.prudenceScore, parseInt(dom.prudenceScore.textContent.replace(/[^0-9-]/g, '')) || 0, prudenceScore, 300);
                
                dom.monthDisplay.textContent = `${currentMonth} / ${totalMonths}`;
                
                if (currentMonth >= totalMonths) {
                    dom.nav.nextMonthBtn.disabled = true;
                    dom.nav.nextMonthBtn.classList.remove('animate-pulse-strong');
                    dom.nav.nextMonthBtn.classList.add('opacity-50');
                    
                    const winner = prudenceScore > 0 ? 'Horizon' : 'Hype';
                    const winnerColor = winner === 'Hype' ? 'text-red-700 bg-red-100' : 'text-teal-700 bg-teal-100';
                    dom.winnerDisplay.innerHTML = `Race Over! ${winner} Wins!`;
                    dom.winnerDisplay.className = `text-lg font-bold p-3 rounded-lg text-center mt-4 ${winnerColor}`;
                }
            };
            
            const renderChart = () => {
                const chartWidth = 300;
                const chartHeight = 150;
                
                const allValues = [...hypeHistory, ...horizonHistory];
                const maxVal = Math.max(...allValues, 2000); // Min y-axis of 2000
                
                const getPoint = (val, index) => {
                    const x = (index / (totalMonths)) * chartWidth;
                    const y = chartHeight - (val / maxVal) * chartHeight * 0.95 - 1;
                    return { x: x.toFixed(2), y: y.toFixed(2) };
                };
                
                const hypePoints = hypeHistory.map((val, i) => getPoint(val, i));
                const horizonPoints = horizonHistory.map((val, i) => getPoint(val, i));
                
                dom.chart.hypeLine.setAttribute('points', hypePoints.map(p => `${p.x},${p.y}`).join(' '));
                dom.chart.horizonLine.setAttribute('points', horizonPoints.map(p => `${p.x},${p.y}`).join(' '));
                
                const lastHypePoint = hypePoints[hypePoints.length - 1];
                const lastHorizonPoint = horizonPoints[horizonPoints.length - 1];
                
                dom.chart.hypeDot.setAttribute('cx', lastHypePoint.x);
                dom.chart.hypeDot.setAttribute('cy', lastHypePoint.y);
                dom.chart.horizonDot.setAttribute('cx', lastHorizonPoint.x);
                dom.chart.horizonDot.setAttribute('cy', lastHorizonPoint.y);
            };
            
            const renderAll = () => {
                renderPortfolios();
                renderChart();
            };

            // --- Core Game Logic ---
            
            const restartSimulation = () => {
                audioManager.play('click');
                currentMonth = 0;
                hypeBalance = 1000;
                horizonBalance = 1000;
                prudenceScore = 0;
                hypeHistory = [1000];
                horizonHistory = [1000];
                
                // Reset badges
                badges.forEach(b => b.unlocked = false);
                
                dom.newsFeed.innerHTML = '<li class="text-center text-gray-400">Press "Next Month" to start!</li>';
                dom.nav.nextMonthBtn.disabled = false;
                dom.nav.nextMonthBtn.classList.add('animate-pulse-strong');
                dom.nav.nextMonthBtn.classList.remove('opacity-50');
                dom.winnerDisplay.className = 'text-lg font-bold p-3 rounded-lg text-center mt-4 hidden';
                
                renderAll();
                renderBadges();
            };
            
            const simulateNextMonth = () => {
                if (currentMonth >= totalMonths) return;
                
                audioManager.play('click');
                currentMonth++;
                
                // 1. Add Monthly Investment
                hypeBalance += monthlyInvestment;
                horizonBalance += monthlyInvestment;
                
                // 2. Draw Market Event
                const event = marketEvents[Math.floor(Math.random() * marketEvents.length)];
                
                // 3. Apply Event Logic
                // Horizon portfolio: baseline growth + event modifier
                horizonBalance = (horizonBalance * HORIZON_GROWTH_RATE) * event.horizonChange;
                
                // Hype portfolio: only event modifier
                if (hypeBalance > 0) { // Can't gain/lose if bankrupt
                    hypeBalance *= event.hypeChange;
                    if (hypeBalance < 1) hypeBalance = 0; // Bankrupt
                }
                
                // 4. Update History
                hypeHistory.push(hypeBalance);
                horizonHistory.push(horizonBalance);
                
                // 5. Update Score
                prudenceScore = Math.floor(horizonBalance - hypeBalance);
                
                // 6. UI/Audio Feedback
                logNews(event.desc, event.type);
                audioManager.play(event.type);
                if (event.type === 'BOOM') flashCard(dom.hypeCard, 'BOOM');
                if (event.type === 'BUST') flashCard(dom.hypeCard, 'BUST');
                if (event.name.includes("RUGPULL")) unlockBadge('RUGPULLED');
                
                // 7. Render & Check Badges
                renderAll();
                checkBadges();
            };

            // --- App Initialization ---
            const initApp = () => {
                // 1. Nav Listeners
                dom.nav.buttons.forEach(btn => {
                    const page = btn.dataset.page;
                    if (page) {
                        btn.addEventListener('click', () => {
                            audioManager.play('click');
                            updatePage(page);
                        });
                    }
                });
                
                // 2. Action Button Listeners
                dom.nav.nextMonthBtn.addEventListener('click', simulateNextMonth);
                dom.nav.restartBtn.addEventListener('click', restartSimulation);
                dom.nav.muteBtn.addEventListener('click', () => audioManager.toggleMute());
                
                // 3. Initial Setup
                populateLessons();
                restartSimulation(); // This also calls renderAll and renderBadges
                updatePage('race');
            };

            initApp();
        });
    </script>
</body>
</html>
